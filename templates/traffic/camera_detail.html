{% extends "base.html" %}

{% block title %}C谩mara {{ camera_id + 1 }} - Sistema de Tr谩fico{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1>
                <i class="fas fa-video"></i> C谩mara {{ camera_id + 1 }}
                <span class="badge bg-{{ 'success' if congestion_level == 'low' else 'warning' if congestion_level == 'medium' else 'danger' }} fs-6">
                    Congesti贸n {{ 'Baja' if congestion_level == 'low' else 'Media' if congestion_level == 'medium' else 'Alta' }}
                </span>
            </h1>
            <div>
                <a href="{{ url_for('traffic.dashboard') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Volver al Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8 mb-4">
        <div class="card bg-dark">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-video"></i> Video en Tiempo Real
                    {% if processing %}
                    <span class="badge bg-success ms-2">Procesamiento Activo</span>
                    {% else %}
                    <span class="badge bg-secondary ms-2">Procesamiento Inactivo</span>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body p-0">
                <img src="{{ url_for('traffic.video_feed', camera_id=camera_id) }}" 
                     class="img-fluid w-100" 
                     alt="C谩mara {{ camera_id + 1 }}"
                     id="cameraFeed">
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Tarjeta de Estad铆sticas en Tiempo Real -->
        <div class="card bg-dark mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar"></i> Estad铆sticas en Tiempo Real
                    <span class="badge bg-info pulse" id="liveBadge">EN VIVO</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3 text-center">
                    <h6>Veh铆culos Detectados Actualmente</h6>
                    <h2 class="text-primary" id="totalVehicles">{{ detection_data.total }}</h2>
                </div>
                
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="border rounded p-2">
                            <small class="text-muted d-block"> Carros</small>
                            <span class="fw-bold fs-5 text-info" id="carroCount">{{ detection_data.carro }}</span>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="border rounded p-2">
                            <small class="text-muted d-block"> Camiones</small>
                            <span class="fw-bold fs-5 text-warning" id="camionCount">{{ detection_data.camion }}</span>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="border rounded p-2">
                            <small class="text-muted d-block"> Buses</small>
                            <span class="fw-bold fs-5 text-success" id="busCount">{{ detection_data.bus }}</span>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="border rounded p-2">
                            <small class="text-muted d-block"> Ambulancias</small>
                            <span class="fw-bold fs-5 text-danger" id="ambulanciaCount">{{ detection_data.ambulancia }}</span>
                        </div>
                    </div>
                    <div class="col-12 mb-3">
                        <div class="border rounded p-2">
                            <small class="text-muted d-block"> Mototaxis</small>
                            <span class="fw-bold fs-5 text-purple" id="mototaxiCount">{{ detection_data.mototaxi }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Informaci贸n del Estado -->
        <div class="card bg-dark">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-info-circle"></i> Informaci贸n del Sistema</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6>Estado de Congesti贸n</h6>
                    <span class="badge bg-{{ 'success' if congestion_level == 'low' else 'warning' if congestion_level == 'medium' else 'danger' }} fs-6 w-100 py-2" id="congestionBadge">
                        {{ 'BAJA' if congestion_level == 'low' else 'MEDIA' if congestion_level == 'medium' else 'ALTA' }}
                    </span>
                </div>
                
                <div class="mt-3">
                    <p class="small mb-1">
                        <i class="fas fa-lightbulb text-warning"></i>
                        <strong>Procesamiento:</strong> 
                        <span id="processingStatus">{{ 'ACTIVO' if processing else 'INACTIVO' }}</span>
                    </p>
                    <p class="small mb-1">
                        <i class="fas fa-robot text-info"></i>
                        Modelo YOLO: best.pt
                    </p>
                    <p class="small mb-1">
                        <i class="fas fa-sync-alt text-success"></i>
                        Datos actualizados en tiempo real
                    </p>
                    <p class="small mb-0">
                        <i class="fas fa-car text-primary"></i>
                        {{ detection_data.total }} veh铆culos detectados actualmente
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Actualizar datos de la c谩mara cada 2 segundos
function updateCameraData() {
    fetch(`/api/camera_data/{{ camera_id }}`)
        .then(response => response.json())
        .then(data => {
            // Actualizar los contadores en tiempo real
            document.getElementById('totalVehicles').textContent = data.detection_data.total;
            document.getElementById('carroCount').textContent = data.detection_data.carro;
            document.getElementById('camionCount').textContent = data.detection_data.camion;
            document.getElementById('busCount').textContent = data.detection_data.bus;
            document.getElementById('ambulanciaCount').textContent = data.detection_data.ambulancia;
            document.getElementById('mototaxiCount').textContent = data.detection_data.mototaxi;
            
            // Actualizar badge de congesti贸n
            const congestionLevel = data.congestion_level;
            let bgClass = 'bg-secondary';
            let text = 'Desconocida';
            
            if (congestionLevel === 'low') {
                bgClass = 'bg-success';
                text = 'BAJA';
            } else if (congestionLevel === 'medium') {
                bgClass = 'bg-warning';
                text = 'MEDIA';
            } else if (congestionLevel === 'high') {
                bgClass = 'bg-danger';
                text = 'ALTA';
            }
            
            const congestionBadge = document.getElementById('congestionBadge');
            congestionBadge.className = `badge ${bgClass} fs-6 w-100 py-2`;
            congestionBadge.textContent = text;
        })
        .catch(error => {
            console.error('Error actualizando datos:', error);
        });
}

// Iniciar actualizaci贸n autom谩tica
setInterval(updateCameraData, 2000);

// Forzar actualizaci贸n inmediata
updateCameraData();

// Manejar errores en la carga de video
document.getElementById('cameraFeed').addEventListener('error', function() {
    console.log('Error cargando video, recargando...');
    setTimeout(() => {
        this.src = this.src.split('?')[0] + '?t=' + new Date().getTime();
    }, 1000);
});
</script>

<style>
.text-purple {
    color: #6f42c1 !important;
}

.pulse {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.border {
    border-color: #444 !important;
}
</style>
{% endblock %}