{% extends "base.html" %}

{% block title %}Dashboard - Sistema de Tr치fico{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1><i class="fas fa-tachometer-alt"></i> Dashboard de Tr치fico Inteligente</h1>
            <button id="toggleProcessing" class="btn {% if processing %}btn-danger{% else %}btn-success{% endif %}">
                <i class="fas {% if processing %}fa-stop{% else %}fa-play{% endif %}"></i>
                {% if processing %}Detener Procesamiento{% else %}Iniciar Procesamiento{% endif %}
            </button>
        </div>
    </div>
</div>

<!-- Alerta de Emergencia -->
{% if emergency_mode.active %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-danger d-flex align-items-center">
            <i class="fas fa-ambulance fa-2x me-3"></i>
            <div>
                <h4 class="alert-heading mb-1">游뚬 MODO EMERGENCIA ACTIVO</h4>
                <p class="mb-0">Ambulancia detectada en C치mara {{ emergency_mode.emergency_camera + 1 }} - Priorizando paso de veh칤culo de emergencia</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Estad칤sticas Generales -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-dark text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-car"></i> Veh칤culos Totales</h5>
                <h2 class="display-4">{{ total_vehicles }}</h2>
                <p class="mb-0">4 c치maras en tiempo real</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-dark text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-weight-hanging"></i> Total Ponderado</h5>
                <h2 class="display-4">{{ "%.1f"|format(total_weighted) }}</h2>
                <small class="text-muted">Considerando pesos de veh칤culos</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-{{ 'success' if total_congestion == 'low' else 'warning' if total_congestion == 'medium' else 'danger' }} text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-traffic-light"></i> Congesti칩n General</h5>
                <h2 class="display-4">
                    {{ 'Baja' if total_congestion == 'low' else 'Media' if total_congestion == 'medium' else 'Alta' }}
                </h2>
                <p class="mb-0">Basado en an치lisis inteligente</p>
            </div>
        </div>
    </div>
</div>

<!-- Desglose por Tipo de Veh칤culo -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-dark">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-chart-pie"></i> Distribuci칩n por Tipo de Veh칤culo</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col">
                        <div class="border rounded p-3">
                            <h6 class="text-info">游뚱 Carros</h6>
                            <h4>{{ type_totals.carro }}</h4>
                            <small class="text-muted">Peso: 1</small>
                        </div>
                    </div>
                    <div class="col">
                        <div class="border rounded p-3">
                            <h6 class="text-warning">游뚵 Camiones</h6>
                            <h4>{{ type_totals.camion }}</h4>
                            <small class="text-muted">Peso: 5</small>
                        </div>
                    </div>
                    <div class="col">
                        <div class="border rounded p-3">
                            <h6 class="text-success">游뚧 Buses</h6>
                            <h4>{{ type_totals.bus }}</h4>
                            <small class="text-muted">Peso: 4</small>
                        </div>
                    </div>
                    <div class="col">
                        <div class="border rounded p-3">
                            <h6 class="text-danger">游뚬 Ambulancias</h6>
                            <h4>{{ type_totals.ambulancia }}</h4>
                            <small class="text-muted">Peso: 10</small>
                        </div>
                    </div>
                    <div class="col">
                        <div class="border rounded p-3">
                            <h6 class="text-purple">游띳 Mototaxis</h6>
                            <h4>{{ type_totals.mototaxi }}</h4>
                            <small class="text-muted">Peso: 0.7</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sistema de Sem치foros Inteligentes -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-dark">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-traffic-light"></i> Sistema de Sem치foros Inteligentes
                    {% if emergency_mode.active %}
                    <span class="badge bg-danger ms-2">MODO EMERGENCIA</span>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Grupo 1: C치maras 0 y 2 -->
                    <div class="col-md-6">
                        <div class="semaphore-group">
                            <h6 class="text-warning">Grupo 1 - Calles Principales</h6>
                            <p class="text-muted small mb-3">C치maras 1 y 3</p>
                            
                            <div class="text-center">
                                <div class="traffic-light">
                                    <div class="light red {% if semaphore_states.group_1.current_color == 'red' %}active{% endif %}"></div>
                                    <div class="light yellow {% if semaphore_states.group_1.current_color == 'yellow' %}active{% endif %} 
                                          {% if semaphore_states.group_1.current_color == 'yellow' %}blink{% endif %}"></div>
                                    <div class="light green {% if semaphore_states.group_1.current_color == 'green' %}active{% endif %}"></div>
                                </div>
                                
                                <div class="semaphore-status bg-{{ 'success' if semaphore_states.group_1.current_color == 'green' else 'warning' if semaphore_states.group_1.current_color == 'yellow' else 'danger' }}">
                                    {{ 'VERDE' if semaphore_states.group_1.current_color == 'green' else 'AMARILLO' if semaphore_states.group_1.current_color == 'yellow' else 'ROJO' }}
                                </div>
                                
                                <div class="mt-3">
                                    <small class="text-muted">Congesti칩n: 
                                        <span class="badge bg-{{ 'success' if group_congestion.group_1 == 'low' else 'warning' if group_congestion.group_1 == 'medium' else 'danger' }}">
                                            {{ 'Baja' if group_congestion.group_1 == 'low' else 'Media' if group_congestion.group_1 == 'medium' else 'Alta' }}
                                        </span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Grupo 2: C치maras 1 y 3 -->
                    <div class="col-md-6">
                        <div class="semaphore-group">
                            <h6 class="text-warning">Grupo 2 - Calles Secundarias</h6>
                            <p class="text-muted small mb-3">C치maras 2 y 4</p>
                            
                            <div class="text-center">
                                <div class="traffic-light">
                                    <div class="light red {% if semaphore_states.group_2.current_color == 'red' %}active{% endif %}"></div>
                                    <div class="light yellow {% if semaphore_states.group_2.current_color == 'yellow' %}active{% endif %} 
                                          {% if semaphore_states.group_2.current_color == 'yellow' %}blink{% endif %}"></div>
                                    <div class="light green {% if semaphore_states.group_2.current_color == 'green' %}active{% endif %}"></div>
                                </div>
                                
                                <div class="semaphore-status bg-{{ 'success' if semaphore_states.group_2.current_color == 'green' else 'warning' if semaphore_states.group_2.current_color == 'yellow' else 'danger' }}">
                                    {{ 'VERDE' if semaphore_states.group_2.current_color == 'green' else 'AMARILLO' if semaphore_states.group_2.current_color == 'yellow' else 'ROJO' }}
                                </div>
                                
                                <div class="mt-3">
                                    <small class="text-muted">Congesti칩n: 
                                        <span class="badge bg-{{ 'success' if group_congestion.group_2 == 'low' else 'warning' if group_congestion.group_2 == 'medium' else 'danger' }}">
                                            {{ 'Baja' if group_congestion.group_2 == 'low' else 'Media' if group_congestion.group_2 == 'medium' else 'Alta' }}
                                        </span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Informaci칩n del Sistema -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <h6 class="alert-heading"><i class="fas fa-brain"></i> Algoritmo Inteligente</h6>
                            <p class="mb-2">El sistema ajusta autom치ticamente los tiempos de sem치foro basado en:</p>
                            <ul class="mb-0">
                                <li><strong>Pesos de veh칤culos:</strong> Carro(1), Cami칩n(5), Bus(4), Ambulancia(10), Mototaxi(0.7)</li>
                                <li><strong>Congesti칩n ponderada:</strong> Calculada en tiempo real</li>
                                <li><strong>Prioridad de emergencia:</strong> Ambulancias tienen m치xima prioridad</li>
                                <li><strong>Balance de tr치fico:</strong> Entre grupos de calles que se cruzan</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- C치maras Individuales -->
<div class="row">
    {% for i in range(4) %}
    <div class="col-lg-6 mb-4">
        <div class="card bg-dark">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0"><i class="fas fa-video"></i> C치mara {{ i + 1 }}</h5>
                <div>
                    <span class="badge bg-{{ 'success' if cameras_data['camera_' ~ i]['weighted_total'] < 8 else 'warning' if cameras_data['camera_' ~ i]['weighted_total'] < 25 else 'danger' }}">
                        {{ cameras_data['camera_' ~ i]['total'] }} veh칤culos
                    </span>
                    {% if cameras_data['camera_' ~ i]['ambulancia'] > 0 %}
                    <span class="badge bg-danger ms-1">游뚬</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body p-0">
                <a href="{{ url_for('traffic.camera_detail', camera_id=i) }}">
                    <img src="{{ url_for('traffic.video_feed', camera_id=i) }}" 
                         class="card-img-top camera-preview" 
                         alt="C치mara {{ i + 1 }}"
                         onerror="this.src='#'">
                </a>
            </div>
            <div class="card-footer">
                <div class="row text-center small">
                    <div class="col-3">
                        <span class="text-info">游뚱 {{ cameras_data['camera_' ~ i]['carro'] }}</span>
                    </div>
                    <div class="col-3">
                        <span class="text-warning">游뚵 {{ cameras_data['camera_' ~ i]['camion'] }}</span>
                    </div>
                    <div class="col-3">
                        <span class="text-success">游띳 {{ cameras_data['camera_' ~ i]['mototaxi'] }}</span>
                    </div>
                    <div class="col-3">
                        <span class="text-danger">游뚬 {{ cameras_data['camera_' ~ i]['ambulancia'] }}</span>
                    </div>
                </div>
                <div class="text-center mt-2">
                    <small class="text-muted">Ponderado: {{ "%.1f"|format(cameras_data['camera_' ~ i]['weighted_total']) }}</small>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('toggleProcessing').addEventListener('click', function() {
    fetch('{{ url_for("traffic.toggle_processing") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.processing) {
            this.innerHTML = '<i class="fas fa-stop"></i> Detener Procesamiento';
            this.classList.remove('btn-success');
            this.classList.add('btn-danger');
        } else {
            this.innerHTML = '<i class="fas fa-play"></i> Iniciar Procesamiento';
            this.classList.remove('btn-danger');
            this.classList.add('btn-success');
        }
        setTimeout(() => location.reload(), 1000);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al cambiar el estado del procesamiento');
    });
});

// Actualizar datos de sem치foros cada 2 segundos
function updateSemaphoreData() {
    fetch('{{ url_for("traffic.api_semaphore_data") }}')
    .then(response => response.json())
    .then(data => {
        // Actualizar estados de sem치foros en tiempo real
        updateSemaphoreUI(data);
    })
    .catch(error => console.error('Error actualizando sem치foros:', error));
}

// Actualizar datos generales cada 3 segundos
function updateDashboardData() {
    fetch('{{ url_for("traffic.api_detection_data") }}')
    .then(response => response.json())
    .then(data => {
        // Actualizar datos del dashboard en tiempo real
        updateDashboardUI(data);
    })
    .catch(error => console.error('Error actualizando dashboard:', error));
}

// Funci칩n para actualizar la UI de sem치foros
function updateSemaphoreUI(data) {
    // Actualizar Grupo 1
    updateSemaphoreGroup('group_1', data.semaphore_states.group_1, data.group_congestion.group_1);
    
    // Actualizar Grupo 2
    updateSemaphoreGroup('group_2', data.semaphore_states.group_2, data.group_congestion.group_2);
    
    // Actualizar modo emergencia si es necesario
    if (data.emergency_mode.active) {
        // Mostrar alerta de emergencia si no est치 visible
        if (!document.querySelector('.alert-danger')) {
            location.reload(); // Recargar para mostrar la alerta
        }
    }
}

function updateSemaphoreGroup(groupName, groupData, congestion) {
    const groupElement = document.querySelector(`.semaphore-group:has(h6:contains("${groupName === 'group_1' ? 'Grupo 1' : 'Grupo 2'}"))`);
    if (!groupElement) return;
    
    // Actualizar luces del sem치foro
    const lights = groupElement.querySelectorAll('.light');
    lights.forEach(light => {
        light.classList.remove('active', 'blink');
    });
    
    if (groupData.current_color === 'red') {
        groupElement.querySelector('.light.red').classList.add('active');
    } else if (groupData.current_color === 'yellow') {
        groupElement.querySelector('.light.yellow').classList.add('active', 'blink');
    } else if (groupData.current_color === 'green') {
        groupElement.querySelector('.light.green').classList.add('active');
    }
    
    // Actualizar estado del sem치foro
    const statusElement = groupElement.querySelector('.semaphore-status');
    statusElement.textContent = groupData.current_color === 'green' ? 'VERDE' : 
                               groupData.current_color === 'yellow' ? 'AMARILLO' : 'ROJO';
    statusElement.className = `semaphore-status bg-${groupData.current_color === 'green' ? 'success' : 
                              groupData.current_color === 'yellow' ? 'warning' : 'danger'}`;
    
    // Actualizar congesti칩n
    const congestionBadge = groupElement.querySelector('.badge');
    congestionBadge.textContent = congestion === 'low' ? 'Baja' : 
                                 congestion === 'medium' ? 'Media' : 'Alta';
    congestionBadge.className = `badge bg-${congestion === 'low' ? 'success' : 
                                congestion === 'medium' ? 'warning' : 'danger'}`;
}

// Funci칩n para actualizar la UI del dashboard
function updateDashboardUI(data) {
    // Actualizar contadores de c치maras si es necesario
    // (esto se puede expandir seg칰n sea necesario)
    console.log('Dashboard actualizado:', data);
}

// Iniciar actualizaciones
setInterval(updateSemaphoreData, 2000);
setInterval(updateDashboardData, 3000);

// Actualizar inmediatamente al cargar la p치gina
updateSemaphoreData();
updateDashboardData();
</script>
{% endblock %}