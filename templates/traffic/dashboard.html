{% extends "base.html" %}

{% block title %}Dashboard - Sistema de Tráfico{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1><i class="fas fa-tachometer-alt"></i> Dashboard de Tráfico</h1>
            <button id="toggleProcessing" class="btn {% if processing %}btn-danger{% else %}btn-success{% endif %}">
                <i class="fas {% if processing %}fa-stop{% else %}fa-play{% endif %}"></i>
                {% if processing %}Detener Procesamiento{% else %}Iniciar Procesamiento{% endif %}
            </button>
        </div>
    </div>
</div>

<!-- Estadísticas Generales -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card bg-dark text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-car"></i> Vehículos Totales</h5>
                <h2 class="display-4">{{ total_vehicles }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card bg-{{ 'success' if total_congestion == 'low' else 'warning' if total_congestion == 'medium' else 'danger' }} text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-traffic-light"></i> Estado de Congestión</h5>
                <h2 class="display-4">
                    {{ 'Baja' if total_congestion == 'low' else 'Media' if total_congestion == 'medium' else 'Alta' }}
                </h2>
            </div>
        </div>
    </div>
</div>

<!-- Semáforos -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card bg-dark">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-traffic-light"></i> Semáforo 1</h5>
            </div>
            <div class="card-body text-center">
                <div class="traffic-light">
                    <div class="light red {% if semaphore_1_state == 'high' %}active{% endif %}"></div>
                    <div class="light yellow {% if semaphore_1_state == 'medium' %}active{% endif %}"></div>
                    <div class="light green {% if semaphore_1_state == 'low' %}active{% endif %}"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card bg-dark">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-traffic-light"></i> Semáforo 2</h5>
            </div>
            <div class="card-body text-center">
                <div class="traffic-light">
                    <div class="light red {% if semaphore_2_state == 'high' %}active{% endif %}"></div>
                    <div class="light yellow {% if semaphore_2_state == 'medium' %}active{% endif %}"></div>
                    <div class="light green {% if semaphore_2_state == 'low' %}active{% endif %}"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cámaras -->
<div class="row">
    {% for i in range(4) %}
    <div class="col-lg-6 mb-4">
        <div class="card bg-dark">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0"><i class="fas fa-video"></i> Cámara {{ i + 1 }}</h5>
                <span class="badge bg-{{ 'success' if detection_data['camera_' ~ i]['total'] < 5 else 'warning' if detection_data['camera_' ~ i]['total'] < 15 else 'danger' }}">
                    {{ detection_data['camera_' ~ i]['total'] }} vehículos
                </span>
            </div>
            <div class="card-body p-0">
                <a href="{{ url_for('traffic.camera_detail', camera_id=i) }}">
                    <img src="{{ url_for('traffic.video_feed', camera_id=i) }}" 
                         class="card-img-top camera-preview" 
                         alt="Cámara {{ i + 1 }}">
                </a>
            </div>
            <div class="card-footer">
                <div class="row text-center">
                    <div class="col">
                        <small class="text-muted">Carros: {{ detection_data['camera_' ~ i]['cars'] }}</small>
                    </div>
                    <div class="col">
                        <small class="text-muted">Camiones: {{ detection_data['camera_' ~ i]['trucks'] }}</small>
                    </div>
                    <div class="col">
                        <small class="text-muted">Mototaxis: {{ detection_data['camera_' ~ i]['mototaxis'] }}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('toggleProcessing').addEventListener('click', function() {
    fetch('{{ url_for("traffic.toggle_processing") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.processing) {
            this.innerHTML = '<i class="fas fa-stop"></i> Detener Procesamiento';
            this.classList.remove('btn-success');
            this.classList.add('btn-danger');
        } else {
            this.innerHTML = '<i class="fas fa-play"></i> Iniciar Procesamiento';
            this.classList.remove('btn-danger');
            this.classList.add('btn-success');
        }
        // Recargar la página para actualizar los datos
        setTimeout(() => location.reload(), 500);
    });
});

// Actualizar datos cada 5 segundos
setInterval(() => {
    fetch('{{ url_for("traffic.api_detection_data") }}')
    .then(response => response.json())
    .then(data => {
        // Actualizar contadores y estados aquí si es necesario
        console.log('Datos actualizados:', data);
    });
}, 5000);
</script>
{% endblock %}